#!/bin/bash
# üì® –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

set -e

echo "üîç –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï TELEGRAM –£–í–ï–î–û–ú–õ–ï–ù–ò–ô"
echo "===================================="

# –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
echo "üì° –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞..."
SETTINGS_RESPONSE=$(curl -s "https://tradingibs.site/api/settings" || echo "")

if [ -z "$SETTINGS_RESPONSE" ]; then
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    exit 1
fi

echo "üìã –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤):"
echo "${SETTINGS_RESPONSE:0:200}..."

# –ü–∞—Ä—Å–∏–º Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
BOT_TOKEN=$(echo "$SETTINGS_RESPONSE" | grep -o '"botToken":"[^"]*"' | cut -d'"' -f4 || echo "")
CHAT_ID=$(echo "$SETTINGS_RESPONSE" | grep -o '"chatId":"[^"]*"' | cut -d'"' -f4 || echo "")

echo ""
echo "üîê –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
echo "   Bot Token: ${BOT_TOKEN:0:10}...****** (–¥–ª–∏–Ω–∞: ${#BOT_TOKEN})"
echo "   Chat ID: $CHAT_ID"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
    echo "‚ùå Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç—ã"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ > Telegram' –Ω–∞ —Å–∞–π—Ç–µ"
    exit 1
fi

if [ "${#BOT_TOKEN}" -lt 20 ]; then
    echo "‚ùå Bot Token —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–≤–æ–∑–º–æ–∂–Ω–æ, –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)"
    echo "   –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π Bot Token –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞"
    exit 1
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è
echo ""
echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."

MESSAGE="üß™ –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
üìÖ –î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')
üöÄ –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!

‚úÖ –ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"

TELEGRAM_RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "chat_id=${CHAT_ID}" \
     -d "text=${MESSAGE}" \
     -d "parse_mode=Markdown" 2>&1)

echo "üîç –û—Ç–≤–µ—Ç Telegram API:"
echo "$TELEGRAM_RESPONSE"

if echo "$TELEGRAM_RESPONSE" | grep -q '"ok":true'; then
    echo ""
    echo "‚úÖ –£–°–ü–ï–•! –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à Telegram —á–∞—Ç"
else
    echo ""
    echo "‚ùå –û–®–ò–ë–ö–ê –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram"
    
    if echo "$TELEGRAM_RESPONSE" | grep -q "chat not found"; then
        echo "   –ü—Ä–æ–±–ª–µ–º–∞: Chat ID –Ω–µ –Ω–∞–π–¥–µ–Ω"
        echo "   –†–µ—à–µ–Ω–∏–µ: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–∞—Ç –∏ Chat ID –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"
    elif echo "$TELEGRAM_RESPONSE" | grep -q "bot was blocked"; then
        echo "   –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        echo "   –†–µ—à–µ–Ω–∏–µ: –†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram"
    elif echo "$TELEGRAM_RESPONSE" | grep -q "Unauthorized"; then
        echo "   –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Bot Token"
        echo "   –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å Bot Token –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö"
    else
        echo "   –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ - —Å–º. –æ—Ç–≤–µ—Ç API –≤—ã—à–µ"
    fi
    
    exit 1
fi

echo ""
echo "üéâ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
echo "   –¢–µ–ø–µ—Ä—å —Å–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"