#!/bin/bash
# üõ°Ô∏è –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ù–ê–î–ï–ñ–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø
# –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¢–û–õ–¨–ö–û —Å–∞–º–æ–≥–æ —Å–≤–µ–∂–µ–≥–æ –∫–æ–¥–∞ –∏–∑ GitHub
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./super-reliable-deploy.sh

set -e

echo "üõ°Ô∏è –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ù–ê–î–ï–ñ–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø"
echo "=========================================="

# 1. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° GITHUB (–ü–û–°–õ–ï–î–ù–Ø–Ø –í–ï–†–°–ò–Ø)
echo "üì• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å GitHub..."
git fetch origin
git reset --hard origin/main
git clean -fd

# 2. –ü–†–û–í–ï–†–ö–ê –í–ï–†–°–ò–ò –ö–û–î–ê
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –∫–æ–¥–∞..."
GIT_COMMIT=$(git rev-parse --short HEAD)
GIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
echo "üìã –í–µ—Ä—Å–∏—è: ${GIT_COMMIT} –æ—Ç ${GIT_DATE}"

# 3. –°–ë–û–†–ö–ê –° –û–ß–ò–°–¢–ö–û–ô
echo "üì¶ –°–±–æ—Ä–∫–∞ —Å –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π..."
rm -rf dist/
npm run build

# 4. –ü–†–û–í–ï–†–ö–ê –°–ë–û–†–ö–ò
if [ ! -f "dist/index.html" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å!"
    exit 1
fi

# 5. –°–û–ó–î–ê–ù–ò–ï –ê–†–•–ò–í–ê –° –ú–ï–¢–ê–î–ê–ù–ù–´–ú–ò
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
ARCHIVE_NAME="super-fresh-${GIT_COMMIT}-${TIMESTAMP}.tgz"
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${ARCHIVE_NAME}"

# –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
echo "{
  \"commit\": \"${GIT_COMMIT}\",
  \"date\": \"${GIT_DATE}\",
  \"timestamp\": \"${TIMESTAMP}\",
  \"build_time\": \"$(date)\"
}" > build-info.json

tar -czf "${ARCHIVE_NAME}" dist/ server/server.js build-info.json

# 6. –û–¢–ü–†–ê–í–ö–ê –ù–ê –°–ï–†–í–ï–†
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp "${ARCHIVE_NAME}" ubuntu@146.235.212.239:~

# 7. –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –° –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ô –ù–ê–î–ï–ñ–ù–û–°–¢–¨–Æ
echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é..."
ssh ubuntu@146.235.212.239 "
cd ~ &&

echo 'üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞...' &&
tar -xzf ${ARCHIVE_NAME} &&

echo 'üßπ –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –°–ï–†–í–ï–†–ê...' &&
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
cd ~/stonks && docker compose down || true

# –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
echo '–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤...' &&
docker system prune -f || true

# –û—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo '–û—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...' &&
rm -rf ~/stonks/dist/* &&
rm -rf ~/stonks/server/server.js.backup 2>/dev/null || true

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ server.js
cp ~/stonks/server/server.js ~/stonks/server/server.js.backup 2>/dev/null || true

echo 'üîÑ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–µ–∂–∏—Ö —Ñ–∞–π–ª–æ–≤...' &&
cp -r ~/dist/* ~/stonks/dist/ &&
cp ~/server/server.js ~/stonks/server/server.js &&

echo 'üìã –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–±–æ—Ä–∫–µ...' &&
cp ~/build-info.json ~/stonks/build-info.json &&

echo 'üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ –∫—ç—à–∞...' &&
cd ~/stonks &&
docker compose build --no-cache &&
docker compose up -d &&

echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (30 —Å–µ–∫)...' &&
sleep 30 &&

echo '‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø:' &&
echo '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:' &&
docker ps --format 'table {{.Names}}\t{{.Status}}' &&

echo -e '\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ:' &&
cat ~/stonks/build-info.json &&

echo -e '\n–°–≤–µ–∂–∏–µ —Ñ–∞–π–ª—ã:' &&
docker exec stonks-frontend find /usr/share/nginx/html/assets -name 'index-*.js' -exec ls -la {} \\; 2>/dev/null || echo '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω' &&

echo -e '\n–¢–µ—Å—Ç API:' &&
timeout 15 curl -s https://tradingibs.site/api/status | head -1 2>/dev/null || echo 'API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' &&

# –û—á–∏—Å—Ç–∫–∞
rm ~/${ARCHIVE_NAME} ~/build-info.json ~/server/ ~/dist/ -rf
"

# 8. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê
echo "üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞
if curl -s -I https://tradingibs.site/ | grep -q "200"; then
    echo "‚úÖ –°–ê–ô–¢ –î–û–°–¢–£–ü–ï–ù!"
else
    echo "‚ö†Ô∏è  –°–ê–ô–¢ –ù–ï–î–û–°–¢–£–ü–ï–ù (–≤–æ–∑–º–æ–∂–Ω–æ, –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è)"
fi

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
rm "${ARCHIVE_NAME}" build-info.json

echo ""
# 9. –û–¢–ü–†–ê–í–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –í TELEGRAM
echo "üì® –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."

# –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
TELEGRAM_SETTINGS=$(curl -s "https://tradingibs.site/api/settings" | grep -o '"telegram":{[^}]*}' | sed 's/"telegram"://') || true

if [ -n "$TELEGRAM_SETTINGS" ]; then
    BOT_TOKEN=$(echo "$TELEGRAM_SETTINGS" | grep -o '"botToken":"[^"]*"' | cut -d'"' -f4)
    CHAT_ID=$(echo "$TELEGRAM_SETTINGS" | grep -o '"chatId":"[^"]*"' | cut -d'"' -f4)
    
    if [ -n "$BOT_TOKEN" ] && [ -n "$CHAT_ID" ] && [ "$BOT_TOKEN" != "" ] && [ "$CHAT_ID" != "" ]; then
        MESSAGE="üöÄ –°–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!"
        MESSAGE="$MESSAGE%0A%0Aüì± –í–µ—Ä—Å–∏—è: ${GIT_COMMIT}"
        MESSAGE="$MESSAGE%0Aüï∞ –î–∞—Ç–∞: ${GIT_DATE}"
        MESSAGE="$MESSAGE%0Aüåê –°–∞–π—Ç: https://tradingibs.site"
        MESSAGE="$MESSAGE%0A%0A‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
        
        curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
             -d "chat_id=${CHAT_ID}" \
             -d "text=${MESSAGE}" \
             -d "parse_mode=HTML" > /dev/null 2>&1 || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram"
        
        echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!"
    else
        echo "‚ö†Ô∏è  Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    fi
else
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
fi

echo ""
echo "üéâ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "üìã –í–µ—Ä—Å–∏—è: ${GIT_COMMIT} –æ—Ç ${GIT_DATE}"
echo "üåê –°–∞–π—Ç: https://tradingibs.site"
echo ""
echo "üí° –ì–ê–†–ê–ù–¢–ò–ò –ù–ê–î–ï–ñ–ù–û–°–¢–ò:"
echo "   ‚úÖ –ö–æ–¥ —Ç–æ–ª—å–∫–æ –∏–∑ GitHub (–ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç)"
echo "   ‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"
echo "   ‚úÖ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ –∫—ç—à–∞"
echo "   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏"
echo "   ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Ä—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
echo "   ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
