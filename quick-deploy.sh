#!/bin/bash
# üöÄ –°–£–ü–ï–†-–ù–ê–î–ï–ñ–ù–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï (–¢–û–õ–¨–ö–û –°–í–ï–ñ–ò–ô –ö–û–î)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./quick-deploy.sh

set -e

echo "üî• –°–£–ü–ï–†-–ù–ê–î–ï–ñ–ù–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –° GIT..."
echo "üì¶ –°–±–æ—Ä–∫–∞ —Å–≤–µ–∂–µ–≥–æ –∫–æ–¥–∞..."

# 1. –°–±–æ—Ä–∫–∞ —Å –æ—á–∏—Å—Ç–∫–æ–π
npm run build

# 2. –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
ARCHIVE_NAME="fresh-deploy-${TIMESTAMP}.tgz"
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${ARCHIVE_NAME}"
tar -czf "${ARCHIVE_NAME}" dist/ server/server.js

# 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp "${ARCHIVE_NAME}" ubuntu@146.235.212.239:~

# 4. –ü–û–õ–ù–ê–Ø –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê –° –û–ß–ò–°–¢–ö–û–ô
echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ —Å –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π..."
ssh ubuntu@146.235.212.239 "
cd ~ &&

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
tar -xzf ${ARCHIVE_NAME} &&

# üßπ –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
echo 'üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤...' &&
rm -rf ~/stonks/dist/assets/* &&
rm -rf ~/stonks/dist/*.html &&
rm -rf ~/stonks/dist/*.ico &&
rm -rf ~/stonks/dist/*.png &&
rm -rf ~/stonks/dist/*.svg &&
rm -rf ~/stonks/dist/*.json &&

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–û–õ–¨–ö–û —Å–≤–µ–∂–∏—Ö —Ñ–∞–π–ª–æ–≤
cp -r dist/* ~/stonks/dist/ &&
cp server/server.js ~/stonks/server/server.js &&

# –£–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
rm ${ARCHIVE_NAME} &&

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ë–ï–ó –ö–≠–®–ê
cd ~/stonks &&
echo 'üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–µ–∑ –∫—ç—à–∞...' &&
docker compose down &&
docker compose build --no-cache &&
docker compose up -d &&

# –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
sleep 25 &&

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo '‚úÖ –°–¢–ê–¢–£–° –ö–û–ù–¢–ï–ô–ù–ï–†–û–í:' &&
docker ps --format 'table {{.Names}}\t{{.Status}}' &&

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–∏—Ö —Ñ–∞–π–ª–æ–≤
echo -e '\nüìÅ –°–í–ï–ñ–ò–ï –§–ê–ô–õ–´:' &&
docker exec stonks-frontend find /usr/share/nginx/html/assets -name 'index-*.js' -exec ls -la {} \\; &&

# –¢–µ—Å—Ç API
echo -e '\nüîó –¢–ï–°–¢ API:' &&
timeout 10 curl -s https://tradingibs.site/api/status | head -1 || echo 'API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)'
"

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
rm "${ARCHIVE_NAME}"

echo "üéâ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "üåê –ü—Ä–æ–≤–µ—Ä—å: https://tradingibs.site"
echo "üí° –§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π!"
