server {
  listen 80;
  server_name _;

  # Security headers
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  # Serve frontend under /stonks base path
  root /usr/share/nginx/html;
  index index.html;

  # Internal auth subrequest to API
  location = /__auth {
    internal;
    proxy_pass http://server:3001/api/auth/check;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # API proxy under /stonks/api/* → server:3001
  location /stonks/api/ {
    proxy_pass http://server:3001/api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Preserve Authorization header for Bearer tokens
    proxy_set_header Authorization $http_authorization;
    # Bump limits/timeouts for larger payloads and slow links
    client_max_body_size 50m;
    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  # Redirect /stonks → /stonks/
  location = /stonks {
    return 301 /stonks/;
  }

  # Public login route (no auth)
  location /stonks/login/ {
    try_files $uri $uri/ /stonks/index.html;
  }

  # No-cache strictly for the HTML entry (drop sub_filter to avoid recursion)
  location = /stonks/index.html {
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
  }

  # Frontend single-page app under /stonks (protected by auth)
  location /stonks/ {
    auth_request /__auth;
    error_page 401 = /stonks/login/;
    try_files $uri $uri/ /stonks/index.html;
  }

  # Redirect common root icons and assets to /stonks equivalents
  location = /favicon.ico { return 301 /stonks/favicon.ico; }
  location = /favicon.svg { return 301 /stonks/favicon.svg; }
  location = /favicon-96x96.png { return 301 /stonks/favicon-96x96.png; }
  location = /apple-touch-icon.png { return 301 /stonks/apple-touch-icon.png; }
  location = /site.webmanifest { return 301 /stonks/site.webmanifest; }
  # If some bundles are referenced from root /assets/*, rewrite to /stonks/assets/*
  location ^~ /assets/ {
    return 301 /stonks$uri;
  }

  # Allow static assets without auth for login page
  location ^~ /stonks/assets/ {
    try_files $uri =404;
  }
}


